name: Flutter Release Build

on:
  push:
    tags:
      - 'v*'  # Changed to match main release workflow
  workflow_dispatch:
    inputs:
      build_macos:
        description: 'Build macOS app'
        required: false
        default: true
        type: boolean
      build_windows:
        description: 'Build Windows app'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    if: ${{ github.event.inputs.build_macos != 'false' || startsWith(github.ref, 'refs/tags/v') }}
    
    defaults:
      run:
        working-directory: flutter_furl
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true

    - name: Enable macOS desktop support
      run: flutter config --enable-macos-desktop

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Generate macOS App Icons
      run: |
        echo "=== Generating macOS App Icons from SVG ==="
        
        # Install rsvg-convert for SVG to PNG conversion
        brew install librsvg
        
        # Create icon directory if it doesn't exist
        ICON_DIR="macos/Runner/Assets.xcassets/AppIcon.appiconset"
        mkdir -p "$ICON_DIR"
        
        # Generate all required icon sizes
        echo "Generating app icons..."
        
        # 16x16
        rsvg-convert assets/icons/padlock_icon.svg -w 16 -h 16 -o "$ICON_DIR/app_icon_16.png"
        
        # 32x32 (for 16@2x and 32@1x)
        rsvg-convert assets/icons/padlock_icon.svg -w 32 -h 32 -o "$ICON_DIR/app_icon_32.png"
        
        # 64x64 (for 32@2x)
        rsvg-convert assets/icons/padlock_icon.svg -w 64 -h 64 -o "$ICON_DIR/app_icon_64.png"
        
        # 128x128 (for 128@1x)
        rsvg-convert assets/icons/padlock_icon.svg -w 128 -h 128 -o "$ICON_DIR/app_icon_128.png"
        
        # 256x256 (for 128@2x and 256@1x)
        rsvg-convert assets/icons/padlock_icon.svg -w 256 -h 256 -o "$ICON_DIR/app_icon_256.png"
        
        # 512x512 (for 256@2x and 512@1x)
        rsvg-convert assets/icons/padlock_icon.svg -w 512 -h 512 -o "$ICON_DIR/app_icon_512.png"
        
        # 1024x1024 (for 512@2x)
        rsvg-convert assets/icons/padlock_icon.svg -w 1024 -h 1024 -o "$ICON_DIR/app_icon_1024.png"
        
        echo "✅ Generated macOS app icons:"
        ls -la "$ICON_DIR"/*.png
        
        # Verify the icons were created correctly
        for icon in "$ICON_DIR"/*.png; do
          if [ -f "$icon" ]; then
            echo "$(basename "$icon"): $(file "$icon")"
          fi
        done

    - name: Build macOS app (release)
      run: flutter build macos --release

    - name: Code sign macOS app (release)
      env:
        CSC_LINK: ${{ secrets.MACOS_CERTIFICATE }}
        CSC_KEY_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
      run: |
        # Check if signing secrets are available
        if [ -z "$CSC_LINK" ]; then
          echo "⚠️  Code signing secrets not available, skipping signing"
          exit 0
        fi
        
        echo "=== Code Signing macOS Flutter App (Electron approach) ==="
        
        # Decode certificate from base64 and save as certificate.p12
        echo "$CSC_LINK" | base64 --decode > certificate.p12
        
        # Create keychain with partition list support
        security create-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$MACOS_KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -lut 21600 build.keychain
        
        # Import certificate with proper flags
        security import certificate.p12 \
          -k build.keychain \
          -P "$CSC_KEY_PASSWORD" \
          -T /usr/bin/codesign \
          -T /usr/bin/security \
          -x
        
        # Set partition list (critical for newer macOS versions)
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s \
          -k "$MACOS_KEYCHAIN_PASSWORD" \
          build.keychain
        
        # Verify certificate is available
        echo "=== Available signing identities ==="
        security find-identity -v -p codesigning build.keychain
        
        # Clean up certificate file
        rm certificate.p12
        
        APP_PATH="build/macos/Build/Products/Release/flutter_furl.app"
        
        echo "=== Deep signing all frameworks and binaries ==="
        # Sign using --deep flag like the Electron example suggests
        codesign --force \
          --deep \
          --verify \
          --verbose=4 \
          --sign "$MACOS_SIGNING_IDENTITY" \
          --timestamp \
          --options runtime \
          --entitlements macos/Runner/DebugProfile.entitlements \
          "$APP_PATH"
        
        echo "=== Verification ==="
        codesign --verify --deep --verbose=4 "$APP_PATH"
        codesign --display --verbose=4 "$APP_PATH"
        
        echo "✓ Code signing completed"
      shell: bash
      continue-on-error: true

    - name: Create DMG
      run: |
        APP_PATH="build/macos/Build/Products/Release/flutter_furl.app"
        DMG_PATH="build/macos/Build/Products/Release/flutter_furl.dmg"
        
        echo "=== Creating DMG with Applications folder ==="
        
        # Create a temporary directory for DMG contents
        mkdir -p dmg_temp
        
        # Copy the app to the temporary directory
        cp -R "$APP_PATH" dmg_temp/
        
        # Create Applications folder symlink for easy installation
        ln -s /Applications dmg_temp/Applications
        
        # Verify DMG contents
        echo "DMG contents:"
        ls -la dmg_temp/
        
        # Create the DMG with proper settings (no custom volume icon)
        hdiutil create -volname "flutter_furl" \
          -srcfolder dmg_temp \
          -ov \
          -format UDZO \
          -imagekey zlib-level=9 \
          "$DMG_PATH"
        
        # Clean up
        rm -rf dmg_temp
        
        echo "DMG created at: $DMG_PATH"
        ls -la "$DMG_PATH"

    - name: Sign DMG
      env:
        MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
      run: |
        DMG_PATH="build/macos/Build/Products/Release/flutter_furl.dmg"
        
        echo "=== Signing DMG ==="
        codesign --force \
          --verify \
          --verbose=4 \
          --sign "$MACOS_SIGNING_IDENTITY" \
          --timestamp \
          --options runtime \
          "$DMG_PATH"
        
        echo "=== Verifying DMG signature ==="
        codesign --verify --verbose=4 "$DMG_PATH"
        codesign --display --verbose=4 "$DMG_PATH"

    - name: Notarize DMG (Using working method)
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASS: ${{ secrets.APPLE_APP_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        DMG_PATH="build/macos/Build/Products/Release/flutter_furl.dmg"
        
        echo "=== Starting notarization of DMG ==="
        echo "DMG file: $DMG_PATH"
        ls -la "$DMG_PATH"
        
        # Submit the DMG for notarization (this method works!)
        xcrun notarytool submit "$DMG_PATH" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_ID_PASS" \
          --team-id "$APPLE_TEAM_ID" \
          --wait \
          --timeout 30m
      shell: bash
      continue-on-error: true

    - name: Prepare macOS artifact for release
      run: |
        DMG_PATH="build/macos/Build/Products/Release/flutter_furl.dmg"
        RELEASE_DMG="flutter_furl-macos-${{ github.ref_name }}.dmg"
        RELEASE_ZIP="flutter_furl-macos-${{ github.ref_name }}.dmg.zip"
        
        # Copy and rename the DMG 
        cp "$DMG_PATH" "$RELEASE_DMG"
        
        echo "✅ Created DMG: $RELEASE_DMG"
        ls -la "$RELEASE_DMG"
        
        # Create ZIP archive containing the DMG
        echo "=== Creating ZIP archive ==="
        zip -9 "$RELEASE_ZIP" "$RELEASE_DMG"
        
        echo "✅ Created ZIP archive: $RELEASE_ZIP"
        ls -la "$RELEASE_ZIP"
        
        # Show compression ratio
        DMG_SIZE=$(stat -f%z "$RELEASE_DMG")
        ZIP_SIZE=$(stat -f%z "$RELEASE_ZIP")
        echo "DMG size: $(numfmt --to=iec $DMG_SIZE)"
        echo "ZIP size: $(numfmt --to=iec $ZIP_SIZE)"
        echo "Compression: $(echo "scale=1; ($DMG_SIZE - $ZIP_SIZE) * 100 / $DMG_SIZE" | bc)% reduction"

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-builds-${{ github.ref_name }}
        path: flutter_furl/flutter_furl-macos-${{ github.ref_name }}.dmg.zip
        retention-days: 90
        if-no-files-found: error

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: ${{ github.event.inputs.build_windows != 'false' || startsWith(github.ref, 'refs/tags/v') }}
    
    defaults:
      run:
        working-directory: flutter_furl
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true

    - name: Enable Windows desktop support
      run: flutter config --enable-windows-desktop

    - name: Get Flutter dependencies
      run: flutter pub get

    - name: Build Windows app (release)
      run: flutter build windows --release

    - name: Create Windows archive
      shell: powershell
      run: |
        $buildPath = "build\windows\x64\runner\Release"
        $zipPath = "flutter_furl-windows-${{ github.ref_name }}.zip"
        Compress-Archive -Path "$buildPath\*" -DestinationPath $zipPath -Force

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds-${{ github.ref_name }}
        path: flutter_furl/flutter_furl-windows-${{ github.ref_name }}.zip
        retention-days: 90

  add-to-release:
    name: Add Flutter Apps to Release
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')  # Changed condition
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List downloaded artifacts
      run: |
        echo "Downloaded Flutter artifacts:"
        find artifacts -type f -name "*.zip" | sort

    - name: Generate Flutter app hashes and update all-hashes.zip
      run: |
        # Create flutter-hashes directory
        mkdir -p flutter-hashes
        
        # Generate hashes for Flutter apps (handle both ZIP and DMG)
        find artifacts -name "flutter_furl-*" -type f \( -name "*.zip" -o -name "*.dmg" \) | while read file; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "Generating hash for $filename"
            # Extract base name, handling double extensions like .dmg.zip
            if [[ "$filename" == *.dmg.zip ]]; then
              base_name="${filename%.dmg.zip}"
            else
              base_name="${filename%.*}"
            fi
            sha256sum "$file" | cut -d' ' -f1 > "flutter-hashes/${base_name}.sha256"
          fi
        done
        
        echo "Generated Flutter hashes:"
        ls -la flutter-hashes/
        
        # Download existing all-hashes.zip from the release (if it exists)
        echo "Attempting to download existing all-hashes.zip..."
        if curl -L -f -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
           "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.ref_name }}" \
           -o release-info.json; then
          
          # Extract download URL for all-hashes.zip
          download_url=$(cat release-info.json | grep -o '"browser_download_url":"[^"]*all-hashes\.zip"' | cut -d'"' -f4)
          
          if [ -n "$download_url" ]; then
            echo "Found existing all-hashes.zip, downloading..."
            curl -L -f "$download_url" -o existing-all-hashes.zip
            
            # Extract existing hashes
            mkdir -p existing-hashes
            cd existing-hashes
            unzip -o ../existing-all-hashes.zip
            cd ..
            
            # Copy existing hashes to flutter-hashes directory
            cp existing-hashes/*.sha256 flutter-hashes/ 2>/dev/null || true
          else
            echo "No existing all-hashes.zip found in release"
          fi
        else
          echo "Could not fetch release info or release doesn't exist yet"
        fi
        
        # Create updated all-hashes.zip
        cd flutter-hashes
        zip ../updated-all-hashes.zip *.sha256
        cd ..
        
        echo "Created updated all-hashes.zip with contents:"
        unzip -l updated-all-hashes.zip

    - name: Add Flutter Apps to Existing Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        # Don't set name or body - let the main workflow handle that
        # This will add files to the existing release created by build-release.yml
        files: |
          artifacts/macos-builds-${{ github.ref_name }}/*
          artifacts/windows-builds-${{ github.ref_name }}/*
          updated-all-hashes.zip
        draft: false
        prerelease: false
        append_body: true  # Add to existing release body
        body: |
          
          ## Flutter GUI Applications
          
          ### Download Options:
          
          **🍎 macOS:**
          - `flutter_furl-macos-*.dmg.zip` - Compressed macOS installer (contains signed and notarized DMG)
          
          **🪟 Windows:**
          - `flutter_furl-windows-*.zip` - Windows executable and dependencies
          
          ### Installation Instructions:
          
          **macOS:** Download the ZIP, extract to get the DMG file, open the DMG, and drag the app to Applications folder.
          
          **Windows:** Download the ZIP, extract to a folder, and run `flutter_furl.exe`.
